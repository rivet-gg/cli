# This GitHub Action workflow is auto-generated by the Rivet CLI 
# (https://github.com/rivet-gg/cli). It is configured based on the rivet.yaml 
# file. Instead of modifying directly, update your rivet.yaml and re-generate 
# this config using `rivet ci generate github`.

name: Deploy to Rivet

on:
  push:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-20.04
    outputs:
      branch_name: ${{ steps.derive_names.outputs.branch_name }}
      ns_name_id: ${{ steps.derive_names.outputs.ns_name_id }}
      version_name: ${{ steps.derive_names.outputs.version_name }}
    defaults:
      run:
        shell: bash
    env:
      RIVET_API_ENDPOINT: "__RIVET_API_ENDPOINT__"
      RIVET_TOKEN: ${{ secrets.RIVET_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rivet CLI
        run: |
          export RIVET_CLI_VERSION="__RIVET_CLI_VERSION__"
          curl -fsSL https://raw.githubusercontent.com/rivet-gg/cli/main/install/unix.sh | sh
      
      - name: Derive names
        id: derive_names
        run: |
          branch_name=${GITHUB_REF#refs/heads/}
          # Max namespace length is 16 characters
          ns_name_id=$(echo $branch_name | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]\+/-/g' | cut -c 1-16)
          short_hash=$(git rev-parse --short HEAD)
          version_name="${short_hash} (${branch_name})"
          echo "branch_name=$branch_name" >> "$GITHUB_OUTPUT"
          echo "ns_name_id=$ns_name_id" >> "$GITHUB_OUTPUT"
          echo "version_name=$version_name" >> "$GITHUB_OUTPUT"

      - name: Validate config
        run: |
          rivet config validate --namespace '${{ steps.derive_names.outputs.ns_name_id }}'

